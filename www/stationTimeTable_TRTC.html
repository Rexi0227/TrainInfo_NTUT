<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/trainTypeColor.css" rel="stylesheet" />
    <script src="js/lineChecker.js"></script>
    <script src="js/trainSchedule.js"></script>
    <title>新竹站時刻表</title>
    <style>
        .lineTitle {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .hour {
            background-color: rgb(212, 212, 212);
            width: 100%;
            font-weight: bold;
        }
        .train {
            width: 50px;
            height: 50px;
            margin: 10px;
        }
        .thead {
            width: 100%;
            display: flex;
            font-weight: bold;
        }
        .trainType {
            border-radius: 10px;
            text-align: center;
            margin-left: 15px;
            margin-right: 15px;
        }
        .traingroupByHour{
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px; /* 元素間間距 */
            padding: 10px;
        }
    </style>
</head>
<body>
    <nav>
        <h1><</h1>
    </nav>
    <div class="header">
        <h4 id="stationName" style="margin: 0;">載入中</h4>
        <div class="lineTitle">
            <div id="lineColor" style="width: 5%; border-radius: 10%;"></div>
            <h2 id="lineName" style="margin: 0;">載入中</h2>
        </div>
    </div>
    <div class="trainList">
        <!--
        <div class="thead">
            <div style="width: 30%; text-align: center;"><p style="margin: 0;">種別/車次</p></div>
            <div style="width: 25%; text-align: center;"><p style="margin: 0;">發車時間</p></div>
            <div style="width: 25%; text-align: center;"><p style="margin: 0;">開往</p></div>
            <div style="width: 20%; text-align: center;"><p style="margin: 0;">備註</p></div>
        </div>
        -->
        <hr />
        <div id="trainList">
            <!--
            <div class='hour'><p style='margin-left:10px'>6時</p></div>
            <div class="traingroupByHour" >
                <div class="train">
                    <h1 style="margin: 0;">00</h1>
                    <p style="margin: 0;">北投</p>
                </div>
                <div class="train">
                    <h1 style="margin: 0;">05</h1>
                    <p style="margin: 0;">北投</p>
                </div><div class="train">
                    <h1 style="margin: 0;">10</h1>
                    <p style="margin: 0;">北投</p>
                </div><div class="train">
                    <h1 style="margin: 0;">15</h1>
                    <p style="margin: 0;">北投</p>
                </div><div class="train">
                    <h1 style="margin: 0;">20</h1>
                    <p style="margin: 0;">北投</p>
                </div><div class="train">
                    <h1 style="margin: 0;">25</h1>
                    <p style="margin: 0;">北投</p>
                </div><div class="train">
                    <h1 style="margin: 0;">30</h1>
                    <p style="margin: 0;">北投</p>
                </div>
            -->
            </div>
        </div>
    </div>

    <script>
        async function fetchTrainSchedule() {
            const params = new URLSearchParams(window.location.search);
            const stationID = params.get("stationID");
            const lineName = params.get("lineName");
            const direction = params.get("direction");
            const date = params.get("date");
            
            const trainList = document.getElementById("trainList");
            trainList.innerHTML = "";

            const response2 = await fetch("json/linelist.json");
            const linelist = await response2.json();
            const line = linelist.lines.find(l => l.name == lineName);

            document.getElementById("lineName").innerHTML = lineName;
            document.getElementById("lineColor").style.backgroundColor = line.color;

            const response3 = await fetch("json/stations.json");
            const stations = await response3.json();

            const station = stations.stations.find(s =>
                s.lines.some(line => line.stationID == stationID)
            );

            if (station) {
                const line = station.lines.find(line => line.stationID == stationID && line.lineName == lineName && line.direction == direction);
                console.log(line)
                document.getElementById("stationName").innerHTML = line.stationNameInLine;
                
            }
            



            const groupedTrains = await fetchMRTtrainSchedule(stationID,date,direction,line);
            // 篩選行車方向
            /*
            const direction = params.get("direction");
            data.StationTimetables[direction].Timetables.forEach(train => {
                const time = train.DepartureTime;
                const hour = time.split(":")[0];
                if (!groupedTrains[hour]) groupedTrains[hour] = [];
                groupedTrains[hour].push(train);
            });
            */
            
            
            


            let html = "";
            const trainObjects = [];  // 存下來以便後續綁定事件

            Object.keys(groupedTrains).sort().forEach(hour => {
                html += `<div class='hour'><p style='margin-left:10px'>${hour}時</p></div>`;
                html += `<div class="traingroupByHour" >`;
                groupedTrains[hour].forEach((train, index) => {
                    //const typeClass = getTrainTypeClass(train.TrainTypeCode);
                    //const typeZh_tw = getTrainType(train.TrainTypeCode);

                    // 給每個班次一個唯一 ID
                    const trainId = `train-${hour}-${index}`;
                    trainObjects.push({ id: trainId, train });
                    html+=`
                        <div id='${trainId}' class="train" style="cursor: pointer";>
                            <h1 style="margin: 0;">${train.DepartureTime.split(":")[1]}</h1>
                            <p style="margin: 0;">${train.destination.Zh_tw}</p>
                        </div>
                    `
                });
                html += `</div>`;
            });

            trainList.innerHTML = html;

            // 綁定事件
            trainObjects.forEach(({ id, train }) => {
                document.getElementById(id).addEventListener('click', () => {
                    window.location.href = `trainTimeTable_TRTC.html?line=${lineName}&lineType=${train.routeId}&direction=${direction}&station=${stationID}&weekday=${dateToWeekday(date)}&departureTime=${train.DepartureTime}`;
                });
            });
        }
        
        function getTrainTypeClass(typeCode) {
            switch (typeCode) {
                case '1': return 'ltd-express';  
                case '2': return 'ltd-express';  
                case '3': return 'ltd-express';  
                case '4': return 'express';  
                case '5': return 'semi-express';
                case '6': return 'local';
                case '7': return 'local';
                case '10': return 'rapid';
                case '11' : return 'ltd-express';
                default: return '';
            }
        }

        function getTrainType(typeCode) {
            switch (typeCode) {
                case '1': return '太魯閣';  // 區間車
                case '2': return '普悠瑪';  // 區間快
                case '3': return '自強';  // 莒光號
                case '4': return '莒光';  // 自強/普悠瑪/太魯閣
                case '5': return '復興';
                case '6': return '區間';
                case '7': return '普快';
                case '10': return '區間快';
                case '11' : return '新自強';
                default: return '';
            }
        }

        function branchLineChecker(trainNo,tripline){
            
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 月份是0-11
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        fetchTrainSchedule();
    </script>
</body>
</html>
